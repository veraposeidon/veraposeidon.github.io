<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.webp" color="#222">
  <meta name="google-site-verification" content="Cj9oDgXxdJe6MoA_lEUQ2rmOouwJeTm5uJNqjhOv8Ng">
  <meta name="msvalidate.01" content="E5D0AA8F5E012DFD9C5F3954DF8283B1">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,700,700italic%7CNoto+Serif+SC:300,300italic,400,400italic,700,700italic%7CSource+Code+Pro:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"shenxiaohai.me","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.15.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"default"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"twikoo","storage":true,"lazyload":false,"nav":null,"activeClass":"twikoo"},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="参照fast.ai第八课的课程和代码，逐步实现： 读取分析PASCAL数据集； 实现图像最大目标分类预测； 实现图像最大目标BBOX区域预测；实现BBOX和分类的同时预测。">
<meta property="og:type" content="article">
<meta property="og:title" content="在PASCAL VOC数据集上的单目标检测">
<meta property="og:url" content="https://shenxiaohai.me/fastai-8-objctDetct/index.html">
<meta property="og:site_name" content="SHEN&#39;s DevNotes">
<meta property="og:description" content="参照fast.ai第八课的课程和代码，逐步实现： 读取分析PASCAL数据集； 实现图像最大目标分类预测； 实现图像最大目标BBOX区域预测；实现BBOX和分类的同时预测。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://res.cloudinary.com/dgchmgebr/image/upload/v1678509739/blog/mohb6y1lgk2pvxo2suiq.png">
<meta property="og:image" content="https://res.cloudinary.com/dgchmgebr/image/upload/v1678509740/blog/an3ykktoa4ew2oplwczr.png">
<meta property="og:image" content="https://res.cloudinary.com/dgchmgebr/image/upload/v1678509741/blog/auoyn9qqf7vvfnfadptx.png">
<meta property="og:image" content="https://res.cloudinary.com/dgchmgebr/image/upload/v1678509741/blog/olxj4esbherffyv4r0xg.png">
<meta property="og:image" content="https://res.cloudinary.com/dgchmgebr/image/upload/v1678509742/blog/h7yisnzcekepxotzgerz.png">
<meta property="og:image" content="https://res.cloudinary.com/dgchmgebr/image/upload/v1678509743/blog/okod4sybtznuepgyt9it.png">
<meta property="og:image" content="https://res.cloudinary.com/dgchmgebr/image/upload/v1678509743/blog/gdxlivbrq94n6j1wypa3.png">
<meta property="og:image" content="https://res.cloudinary.com/dgchmgebr/image/upload/v1678509744/blog/h5npa7nchalbd0e2b5xf.png">
<meta property="og:image" content="https://res.cloudinary.com/dgchmgebr/image/upload/v1678509745/blog/tsgncviwit6tugulvqop.png">
<meta property="og:image" content="https://res.cloudinary.com/dgchmgebr/image/upload/v1678509748/blog/p0mv71xeeadjdupfc6ci.png">
<meta property="og:image" content="https://res.cloudinary.com/dgchmgebr/image/upload/v1678509749/blog/a9jodajzh8bgdpjpymvu.png">
<meta property="og:image" content="https://res.cloudinary.com/dgchmgebr/image/upload/v1678509749/blog/wvjvaehmny7u4znu4ohy.png">
<meta property="og:image" content="https://res.cloudinary.com/dgchmgebr/image/upload/v1678509750/blog/wlblzwpsduyqtqbbcwgz.png">
<meta property="og:image" content="https://res.cloudinary.com/dgchmgebr/image/upload/v1678509751/blog/hqgm6vs0ju5tmkk8axcc.png">
<meta property="og:image" content="https://res.cloudinary.com/dgchmgebr/image/upload/v1678509753/blog/pbtycrbhcg4cvhvyj1it.png">
<meta property="og:image" content="https://res.cloudinary.com/dgchmgebr/image/upload/v1678509753/blog/or6b2u4lg6zydboucjqx.png">
<meta property="og:image" content="https://res.cloudinary.com/dgchmgebr/image/upload/v1678509754/blog/tbopav0ye3eqp1w1zruu.png">
<meta property="og:image" content="https://res.cloudinary.com/dgchmgebr/image/upload/v1678509755/blog/tj4k0uaocg6f79egnuof.png">
<meta property="og:image" content="https://res.cloudinary.com/dgchmgebr/image/upload/v1678509756/blog/naulhcykgbzjpsbxlifv.png">
<meta property="article:published_time" content="2018-11-12T09:00:29.000Z">
<meta property="article:modified_time" content="2023-04-02T11:05:05.528Z">
<meta property="article:author" content="xiaohai">
<meta property="article:tag" content="计算机视觉">
<meta property="article:tag" content="深度学习">
<meta property="article:tag" content="PyTorch">
<meta property="article:tag" content="fast.ai">
<meta property="article:tag" content="标注">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://res.cloudinary.com/dgchmgebr/image/upload/v1678509739/blog/mohb6y1lgk2pvxo2suiq.png">


<link rel="canonical" href="https://shenxiaohai.me/fastai-8-objctDetct/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://shenxiaohai.me/fastai-8-objctDetct/","path":"fastai-8-objctDetct/","title":"在PASCAL VOC数据集上的单目标检测"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>在PASCAL VOC数据集上的单目标检测 | SHEN's DevNotes</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YDT7F4NZP6"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-YDT7F4NZP6","only_pageview":false}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="SHEN's DevNotes" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">SHEN's DevNotes</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">学习笔记，编程技巧，效率工具</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">131</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">18</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">74</span></a></li><li class="menu-item menu-item-碎碎念-|-memos"><a href="https://memos.shenxiaohai.me/" rel="section" target="_blank"><i class="fa fa-file-pen fa-fw"></i>碎碎念 | Memos</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Fast-ai-Lesson-8-%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B"><span class="nav-text">Fast.ai Lesson 8: 目标检测</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Pascal-VOC-%E6%95%B0%E6%8D%AE%E9%9B%86"><span class="nav-text">Pascal VOC 数据集</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA%E5%85%B3%E7%B3%BB%E5%AD%97%E5%85%B8"><span class="nav-text">构建关系字典</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BBox%E8%BD%AC%E6%8D%A2"><span class="nav-text">BBox转换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E5%9B%BE%E5%83%8F%E6%A0%87%E6%B3%A8%E6%98%BE%E7%A4%BA"><span class="nav-text">实现图像标注显示</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%80%E5%A4%A7%E7%9B%AE%E6%A0%87%E5%88%86%E7%B1%BB%E5%99%A8"><span class="nav-text">最大目标分类器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%88%86%E7%B1%BB%E6%95%B0%E6%8D%AE%E9%9B%86"><span class="nav-text">创建分类数据集</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E7%B1%BB%E6%A8%A1%E5%9E%8B%E5%92%8C%E8%AE%AD%E7%BB%83"><span class="nav-text">分类模型和训练</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E7%B1%BB%E6%B5%8B%E8%AF%95"><span class="nav-text">分类测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BBox%E9%A2%84%E6%B5%8B"><span class="nav-text">BBox预测</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BABBox%E7%9A%84CSV%E6%96%87%E4%BB%B6"><span class="nav-text">创建BBox的CSV文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A8%A1%E5%9E%8B%E5%92%8C%E8%AE%AD%E7%BB%83"><span class="nav-text">模型和训练</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Data-Augmentation"><span class="nav-text">Data Augmentation</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89-%E7%BD%91%E7%BB%9C%E5%B1%82"><span class="nav-text">自定义 网络层</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%AD%E7%BB%83"><span class="nav-text">训练</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%95%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B"><span class="nav-text">单目标检测</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE"><span class="nav-text">数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BD%91%E7%BB%9C%E7%BB%93%E6%9E%84"><span class="nav-text">网络结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8D%9F%E5%A4%B1%E5%87%BD%E6%95%B0"><span class="nav-text">损失函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%AD%E7%BB%83-1"><span class="nav-text">训练</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A2%84%E6%B5%8B"><span class="nav-text">预测</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#End"><span class="nav-text">End</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">xiaohai</p>
  <div class="site-description" itemprop="description">我在这个技术博客中分享学习笔记，提供实用技巧和工具资源。</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">74</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">131</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/veraposeidon" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;veraposeidon" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/HiYoake" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;HiYoake" rel="noopener me" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/big/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shenxiaohai.me/fastai-8-objctDetct/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="xiaohai">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SHEN's DevNotes">
      <meta itemprop="description" content="我在这个技术博客中分享学习笔记，提供实用技巧和工具资源。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="在PASCAL VOC数据集上的单目标检测 | SHEN's DevNotes">
      <meta itemprop="description" content="参照fast.ai第八课的课程和代码，逐步实现：</br> 读取分析PASCAL数据集； </br>实现图像最大目标分类预测；</br> 实现图像最大目标BBOX区域预测；</br>实现BBOX和分类的同时预测。">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          在PASCAL VOC数据集上的单目标检测
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-11-12 09:00:29" itemprop="dateCreated datePublished" datetime="2018-11-12T09:00:29Z">2018-11-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-04-02 11:05:05" itemprop="dateModified" datetime="2023-04-02T11:05:05Z">2023-04-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%A7%86%E8%A7%89/" itemprop="url" rel="index"><span itemprop="name">计算机视觉</span></a>
        </span>
    </span>

  
</div>

            <div class="post-description">参照fast.ai第八课的课程和代码，逐步实现：</br> 读取分析PASCAL数据集； </br>实现图像最大目标分类预测；</br> 实现图像最大目标BBOX区域预测；</br>实现BBOX和分类的同时预测。</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="Fast-ai-Lesson-8-目标检测"><a href="#Fast-ai-Lesson-8-目标检测" class="headerlink" title="Fast.ai Lesson 8: 目标检测"></a>Fast.ai Lesson 8: 目标检测</h1><p>fast.ai 0.7版本</p>
<p>Pytorch 0.3版本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Jupyter 初始化</span></span><br><span class="line">%matplotlib inline</span><br><span class="line">%config InlineBackend.figure_format=<span class="string">&quot;retina&quot;</span></span><br><span class="line">%config InlineBackend.rc = &#123;<span class="string">&quot;figure.figsize&quot;</span>: (<span class="number">7.5</span>,<span class="number">4.5</span>)&#125;</span><br><span class="line"></span><br><span class="line">%reload_ext autoreload</span><br><span class="line">%autoreload <span class="number">2</span></span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># import fast.ai packages</span></span><br><span class="line"><span class="keyword">from</span> fastai.conv_learner <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> fastai.dataset <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> ImageDraw, ImageFont</span><br><span class="line"><span class="keyword">from</span> matplotlib <span class="keyword">import</span> patches, patheffects</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 指定GPUY</span></span><br><span class="line">torch.cuda.set_device(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<h2 id="Pascal-VOC-数据集"><a href="#Pascal-VOC-数据集" class="headerlink" title="Pascal VOC 数据集"></a>Pascal VOC 数据集</h2><p>官网 <a target="_blank" rel="noopener" href="http://host.robots.ox.ac.uk/pascal/VOC/">The PASCAL Visual Object Classes Homepage</a></p>
<p>数据集镜像网站 <a target="_blank" rel="noopener" href="https://pjreddie.com/projects/pascal-voc-dataset-mirror/">Pascal VOC Dataset Mirror</a></p>
<p>Json格式的标注文件更便于处理 <a target="_blank" rel="noopener" href="https://storage.googleapis.com/coco-dataset/external/PASCAL_VOC.zip">https://storage.googleapis.com/coco-dataset/external/PASCAL_VOC.zip</a></p>
<p>这次实验用的是2007版本的数据集。</p>
<h3 id="构建关系字典"><a href="#构建关系字典" class="headerlink" title="构建关系字典"></a>构建关系字典</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看文件</span></span><br><span class="line">PATH = Path(<span class="string">&#x27;data/pascal2007&#x27;</span>)</span><br><span class="line"><span class="built_in">list</span>(PATH.iterdir())</span><br></pre></td></tr></table></figure>




<pre><code>[PosixPath(&#39;data/pascal2007/tmp&#39;),
 PosixPath(&#39;data/pascal2007/models&#39;),
 PosixPath(&#39;data/pascal2007/pascal_test2007.json&#39;),
 PosixPath(&#39;data/pascal2007/raw&#39;),
 PosixPath(&#39;data/pascal2007/pascal_train2007.json&#39;),
 PosixPath(&#39;data/pascal2007/pascal_val2007.json&#39;),
 PosixPath(&#39;data/pascal2007/VOCdevkit&#39;),
 PosixPath(&#39;data/pascal2007/pascal_train2012.json&#39;),
 PosixPath(&#39;data/pascal2007/pascal_val2012.json&#39;)]
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 打开训练集 标注文件</span></span><br><span class="line">trn_j = json.load((PATH/<span class="string">&#x27;pascal_train2007.json&#x27;</span>).<span class="built_in">open</span>())</span><br><span class="line">trn_j.keys()</span><br></pre></td></tr></table></figure>




<pre><code>dict_keys([&#39;images&#39;, &#39;type&#39;, &#39;annotations&#39;, &#39;categories&#39;])
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用常量来替代字符串：可以自动填充，防止拼写出错</span></span><br><span class="line">IMAGES,ANNOTATIONS,CATEGORIES = [<span class="string">&#x27;images&#x27;</span>, <span class="string">&#x27;annotations&#x27;</span>, <span class="string">&#x27;categories&#x27;</span>]</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">trn_j[IMAGES][:<span class="number">5</span>]</span><br></pre></td></tr></table></figure>




<pre><code>[&#123;&#39;file_name&#39;: &#39;000012.jpg&#39;, &#39;height&#39;: 333, &#39;width&#39;: 500, &#39;id&#39;: 12&#125;,
 &#123;&#39;file_name&#39;: &#39;000017.jpg&#39;, &#39;height&#39;: 364, &#39;width&#39;: 480, &#39;id&#39;: 17&#125;,
 &#123;&#39;file_name&#39;: &#39;000023.jpg&#39;, &#39;height&#39;: 500, &#39;width&#39;: 334, &#39;id&#39;: 23&#125;,
 &#123;&#39;file_name&#39;: &#39;000026.jpg&#39;, &#39;height&#39;: 333, &#39;width&#39;: 500, &#39;id&#39;: 26&#125;,
 &#123;&#39;file_name&#39;: &#39;000032.jpg&#39;, &#39;height&#39;: 281, &#39;width&#39;: 500, &#39;id&#39;: 32&#125;]
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">trn_j[ANNOTATIONS][:<span class="number">2</span>]</span><br></pre></td></tr></table></figure>




<pre><code>[&#123;&#39;segmentation&#39;: [[155, 96, 155, 270, 351, 270, 351, 96]],
  &#39;area&#39;: 34104,
  &#39;iscrowd&#39;: 0,
  &#39;image_id&#39;: 12,
  &#39;bbox&#39;: [155, 96, 196, 174],
  &#39;category_id&#39;: 7,
  &#39;id&#39;: 1,
  &#39;ignore&#39;: 0&#125;,
 &#123;&#39;segmentation&#39;: [[184, 61, 184, 199, 279, 199, 279, 61]],
  &#39;area&#39;: 13110,
  &#39;iscrowd&#39;: 0,
  &#39;image_id&#39;: 17,
  &#39;bbox&#39;: [184, 61, 95, 138],
  &#39;category_id&#39;: 15,
  &#39;id&#39;: 2,
  &#39;ignore&#39;: 0&#125;]
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">trn_j[CATEGORIES][:<span class="number">5</span>]</span><br></pre></td></tr></table></figure>




<pre><code>[&#123;&#39;supercategory&#39;: &#39;none&#39;, &#39;id&#39;: 1, &#39;name&#39;: &#39;aeroplane&#39;&#125;,
 &#123;&#39;supercategory&#39;: &#39;none&#39;, &#39;id&#39;: 2, &#39;name&#39;: &#39;bicycle&#39;&#125;,
 &#123;&#39;supercategory&#39;: &#39;none&#39;, &#39;id&#39;: 3, &#39;name&#39;: &#39;bird&#39;&#125;,
 &#123;&#39;supercategory&#39;: &#39;none&#39;, &#39;id&#39;: 4, &#39;name&#39;: &#39;boat&#39;&#125;,
 &#123;&#39;supercategory&#39;: &#39;none&#39;, &#39;id&#39;: 5, &#39;name&#39;: &#39;bottle&#39;&#125;]
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用常量来替代字符串：可以自动填充，防止拼写出错</span></span><br><span class="line">FILE_NAME,ID,IMG_ID,CAT_ID,BBOX = [<span class="string">&#x27;file_name&#x27;</span>,<span class="string">&#x27;id&#x27;</span>,<span class="string">&#x27;image_id&#x27;</span>,<span class="string">&#x27;category_id&#x27;</span>,<span class="string">&#x27;bbox&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建字典:分类ID-&gt;分类名称</span></span><br><span class="line">cats = &#123;o[ID]:o[<span class="string">&#x27;name&#x27;</span>] <span class="keyword">for</span> o <span class="keyword">in</span> trn_j[CATEGORIES]&#125;</span><br><span class="line"><span class="comment"># 构建字典：图像ID-&gt;图像名称</span></span><br><span class="line">trn_fns = &#123;o[ID]:o[FILE_NAME] <span class="keyword">for</span> o <span class="keyword">in</span> trn_j[IMAGES]&#125;</span><br><span class="line"><span class="comment"># 构建图像编号序列，用以查询是否存在此图</span></span><br><span class="line">trn_ids = &#123;o[ID] <span class="keyword">for</span> o <span class="keyword">in</span> trn_j[IMAGES]&#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看PASCAL数据集文件</span></span><br><span class="line"><span class="built_in">list</span>((PATH/<span class="string">&#x27;VOCdevkit&#x27;</span>/<span class="string">&#x27;VOC2007&#x27;</span>).iterdir())</span><br></pre></td></tr></table></figure>




<pre><code>[PosixPath(&#39;data/pascal2007/VOCdevkit/VOC2007/SegmentationObject&#39;),
 PosixPath(&#39;data/pascal2007/VOCdevkit/VOC2007/JPEGImages&#39;),
 PosixPath(&#39;data/pascal2007/VOCdevkit/VOC2007/ImageSets&#39;),
 PosixPath(&#39;data/pascal2007/VOCdevkit/VOC2007/SegmentationClass&#39;),
 PosixPath(&#39;data/pascal2007/VOCdevkit/VOC2007/Annotations&#39;)]
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置数据集图像路径</span></span><br><span class="line">JPEGS = <span class="string">&quot;VOCdevkit/VOC2007/JPEGImages&quot;</span></span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 验证路径设置</span></span><br><span class="line">IMG_PATH = PATH/JPEGS</span><br><span class="line"><span class="built_in">list</span>(IMG_PATH.iterdir())[:<span class="number">5</span>]</span><br></pre></td></tr></table></figure>




<pre><code>[PosixPath(&#39;data/pascal2007/VOCdevkit/VOC2007/JPEGImages/005601.jpg&#39;),
 PosixPath(&#39;data/pascal2007/VOCdevkit/VOC2007/JPEGImages/009666.jpg&#39;),
 PosixPath(&#39;data/pascal2007/VOCdevkit/VOC2007/JPEGImages/008026.jpg&#39;),
 PosixPath(&#39;data/pascal2007/VOCdevkit/VOC2007/JPEGImages/004041.jpg&#39;),
 PosixPath(&#39;data/pascal2007/VOCdevkit/VOC2007/JPEGImages/008781.jpg&#39;)]
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 每张图像都有一个独立的ID</span></span><br><span class="line">im0_d = trn_j[IMAGES][<span class="number">0</span>]</span><br><span class="line">im0_d[FILE_NAME],im0_d[ID]</span><br></pre></td></tr></table></figure>




<pre><code>(&#39;000012.jpg&#39;, 12)
</code></pre>
<h3 id="BBox转换"><a href="#BBox转换" class="headerlink" title="BBox转换"></a>BBox转换</h3><p>Python中的collections.defaultdict()可以有效解决字典使用中的默认值设置问题。</p>
<p>参考链接： <a target="_blank" rel="noopener" href="https://www.jianshu.com/p/26df28b3bfc8">Python中collections.defaultdict()使用</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将PASCAL数据集中，bbox的形式从高/宽的方式转换成左上角/右下角的形式</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hw_bb</span>(<span class="params">bb</span>): </span><br><span class="line">    <span class="keyword">return</span> np.array([bb[<span class="number">1</span>], bb[<span class="number">0</span>], bb[<span class="number">3</span>]+bb[<span class="number">1</span>]-<span class="number">1</span>, bb[<span class="number">2</span>]+bb[<span class="number">0</span>]-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建标注字典，图像ID-&gt;bbx集(bbx,分类ID)，默认为空序列</span></span><br><span class="line">trn_anno = collections.defaultdict(<span class="keyword">lambda</span>: [])</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> o <span class="keyword">in</span> trn_j[ANNOTATIONS]:</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> o[<span class="string">&#x27;ignore&#x27;</span>]:</span><br><span class="line">        bbx = o[BBOX]</span><br><span class="line">        bbx = hw_bb(bbx)</span><br><span class="line">        trn_anno[o[IMG_ID]].append((bbx, o[CAT_ID]))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看标注长度</span></span><br><span class="line"><span class="built_in">len</span>(trn_anno)</span><br></pre></td></tr></table></figure>




<pre><code>2501
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 抽查,一幅图对应的标注序列</span></span><br><span class="line">im_a = trn_anno[im0_d[ID]];</span><br><span class="line">im_a</span><br></pre></td></tr></table></figure>




<pre><code>[(array([ 96, 155, 269, 350]), 7)]
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 抽查，一幅图中标注序列的第一个标注</span></span><br><span class="line">im0_a = im_a[<span class="number">0</span>];</span><br><span class="line">im0_a</span><br></pre></td></tr></table></figure>




<pre><code>(array([ 96, 155, 269, 350]), 7)
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 根据分类ID查看分类名称</span></span><br><span class="line"><span class="comment"># cats[7]</span></span><br><span class="line">cats[im0_a[<span class="number">1</span>]]</span><br></pre></td></tr></table></figure>




<pre><code>&#39;car&#39;
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">trn_anno[<span class="number">17</span>]</span><br></pre></td></tr></table></figure>




<pre><code>[(array([ 61, 184, 198, 278]), 15), (array([ 77,  89, 335, 402]), 13)]
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cats[<span class="number">15</span>],cats[<span class="number">13</span>]</span><br></pre></td></tr></table></figure>




<pre><code>(&#39;person&#39;, &#39;horse&#39;)
</code></pre>
<p>有些图表库在绘制时采用的跟VOC的格式相同，所以也可以添加一个函数用于，将左上角&#x2F;右下角转换成宽和高。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bb_voc = [<span class="number">155</span>, <span class="number">96</span>, <span class="number">196</span>, <span class="number">174</span>]</span><br><span class="line">bb_fastai = hw_bb(bb_voc)</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将左上角/右下角转换成宽和高形式。</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bb_hw</span>(<span class="params">a</span>):</span><br><span class="line">    <span class="keyword">return</span> np.array([a[<span class="number">1</span>],a[<span class="number">0</span>],a[<span class="number">3</span>]-a[<span class="number">1</span>]+<span class="number">1</span>,a[<span class="number">2</span>]-a[<span class="number">0</span>]+<span class="number">1</span>])</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">f&#x27;expected: <span class="subst">&#123;bb_voc&#125;</span>, actual: <span class="subst">&#123;bb_hw(bb_fastai)&#125;</span>&#x27;</span></span><br></pre></td></tr></table></figure>




<pre><code>&#39;expected: [155, 96, 196, 174], actual: [155  96 196 174]&#39;
</code></pre>
<h3 id="实现图像标注显示"><a href="#实现图像标注显示" class="headerlink" title="实现图像标注显示"></a>实现图像标注显示</h3><p>fast.ai库中打开图像是通过opencv打开的，效率比PIL方式快很多。</p>
<p>OpenCV打开的速度比Torchvision快5-10倍。同时，fast.ai快的原因不是采用多进程而是采用多线程进行数据增强处理。</p>
<p>坚持用Opencv来做数据增强，而不要采用TorchVision或者Pillow。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 调用fast.ai的open_image函数打开图像</span></span><br><span class="line">im = open_image(IMG_PATH/im0_d[FILE_NAME])</span><br></pre></td></tr></table></figure>

<p>Matplotlib中的plt.subplots是一个面向对象的非常实用的工具。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义一个显示图像的函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show_img</span>(<span class="params">im, figsize=<span class="literal">None</span>, ax=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> ax: fig,ax = plt.subplots(figsize=figsize)</span><br><span class="line">    ax.imshow(im)</span><br><span class="line">    ax.get_xaxis().set_visible(<span class="literal">False</span>)</span><br><span class="line">    ax.get_yaxis().set_visible(<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">return</span> ax</span><br></pre></td></tr></table></figure>

<p>fast.ai的作者的创意：无视背景色的前景文本和矩形框，加一个包边处理。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 画出bbox的黑色包边效果</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">draw_outline</span>(<span class="params">o, lw</span>):</span><br><span class="line">    o.set_path_effects([patheffects.Stroke(</span><br><span class="line">        linewidth=lw, foreground=<span class="string">&#x27;black&#x27;</span>), patheffects.Normal()])</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 画出bbox的白色包边</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">draw_rect</span>(<span class="params">ax, b</span>):</span><br><span class="line">    patch = ax.add_patch(patches.Rectangle(b[:<span class="number">2</span>], *b[-<span class="number">2</span>:], fill=<span class="literal">False</span>, edgecolor=<span class="string">&#x27;white&#x27;</span>, lw=<span class="number">2</span>))</span><br><span class="line">    draw_outline(patch, <span class="number">4</span>)</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 白色标签文字，并加上黑色包边</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">draw_text</span>(<span class="params">ax, xy, txt, sz=<span class="number">14</span></span>):</span><br><span class="line">    text = ax.text(*xy, txt,</span><br><span class="line">        verticalalignment=<span class="string">&#x27;top&#x27;</span>, color=<span class="string">&#x27;white&#x27;</span>, fontsize=sz, weight=<span class="string">&#x27;bold&#x27;</span>)</span><br><span class="line">    draw_outline(text, <span class="number">1</span>)</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ax = show_img(im)</span><br><span class="line">b = bb_hw(im0_a[<span class="number">0</span>])</span><br><span class="line">draw_rect(ax, b)</span><br><span class="line">draw_text(ax, b[:<span class="number">2</span>], cats[im0_a[<span class="number">1</span>]]) <span class="comment">#b[:2]是左上角的点</span></span><br></pre></td></tr></table></figure>


<p><img data-src="https://res.cloudinary.com/dgchmgebr/image/upload/v1678509739/blog/mohb6y1lgk2pvxo2suiq.png" alt="png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义一个画图和标注的函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">draw_im</span>(<span class="params">im, ann</span>):</span><br><span class="line">    ax = show_img(im, figsize=(<span class="number">16</span>,<span class="number">8</span>))</span><br><span class="line">    <span class="keyword">for</span> b,c <span class="keyword">in</span> ann:</span><br><span class="line">        b = bb_hw(b)</span><br><span class="line">        draw_rect(ax, b)</span><br><span class="line">        draw_text(ax, b[:<span class="number">2</span>], cats[c], sz=<span class="number">16</span>)</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义一个根据训练集图像ID,画出图像和标注的工具函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">draw_idx</span>(<span class="params">i</span>):</span><br><span class="line">    im_a = trn_anno[i]</span><br><span class="line">    im = open_image(IMG_PATH/trn_fns[i])</span><br><span class="line">    <span class="built_in">print</span>(im.shape)</span><br><span class="line">    draw_im(im, im_a)</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">draw_idx(<span class="number">9654</span>)</span><br></pre></td></tr></table></figure>

<pre><code>(500, 333, 3)
</code></pre>
<p><img data-src="https://res.cloudinary.com/dgchmgebr/image/upload/v1678509740/blog/an3ykktoa4ew2oplwczr.png" alt="png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%debug</span><br></pre></td></tr></table></figure>

<pre><code>ERROR:root:No traceback has been produced, nothing to debug.
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">draw_idx(<span class="number">17</span>)</span><br></pre></td></tr></table></figure>

<pre><code>(364, 480, 3)
</code></pre>
<p><img data-src="https://res.cloudinary.com/dgchmgebr/image/upload/v1678509741/blog/auoyn9qqf7vvfnfadptx.png" alt="png"></p>
<h2 id="最大目标分类器"><a href="#最大目标分类器" class="headerlink" title="最大目标分类器"></a>最大目标分类器</h2><p>实现图像中最大的目标的分类。下一步再进行定位。</p>
<p>分类器的训练集是将VOC数据集中最大标注面积的物体作为整幅图像的分类目标来做训练的。</p>
<h3 id="创建分类数据集"><a href="#创建分类数据集" class="headerlink" title="创建分类数据集"></a>创建分类数据集</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义一个函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_lrg</span>(<span class="params">a,b</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> b: <span class="keyword">raise</span> Exception(<span class="string">&quot;b is null&quot;</span>)</span><br><span class="line">    <span class="comment"># 按照bbox进行排序</span></span><br><span class="line">    b = <span class="built_in">sorted</span>(b, key=<span class="keyword">lambda</span> x:np.product(x[<span class="number">0</span>][-<span class="number">2</span>:] - x[<span class="number">0</span>][:<span class="number">2</span>]), reverse=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># 返回最大bbox</span></span><br><span class="line">    <span class="keyword">return</span> b[<span class="number">0</span>]</span><br></pre></td></tr></table></figure>

<p>lambda可以用来构建简单的函数，下面这个函数用lambda函数来表示对标注序列按照bbox面积进行排序</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 构建一个字典，图像ID-&gt;最大标注框和分类</span></span><br><span class="line">trn_lrg_anno = &#123;a: get_lrg(a,b) <span class="keyword">for</span> a,b <span class="keyword">in</span> trn_anno.items()&#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">b,c = trn_lrg_anno[<span class="number">17</span>]</span><br><span class="line">b = bb_hw(b)</span><br><span class="line">ax = show_img(open_image(IMG_PATH/trn_fns[<span class="number">17</span>]), figsize=(<span class="number">5</span>,<span class="number">10</span>))</span><br><span class="line">draw_rect(ax,b)</span><br><span class="line">draw_text(ax,b[:<span class="number">2</span>],cats[c],sz=<span class="number">16</span>)</span><br></pre></td></tr></table></figure>


<p><img data-src="https://res.cloudinary.com/dgchmgebr/image/upload/v1678509741/blog/olxj4esbherffyv4r0xg.png" alt="png"></p>
<p>fast.ai库中构建许多创建数据集的方式，其中一个就是从CSV文件中构建数据集。</p>
<p><strong>所以，与其自己定义Dataset并构建数据集，不如直接将已有的数据保存到csv文件中，再调用API直接进行dataset和dataloader的生成</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义路径</span></span><br><span class="line">(PATH/<span class="string">&#x27;tmp&#x27;</span>).mkdir(exist_ok=<span class="literal">True</span>)</span><br><span class="line">CSV = PATH/<span class="string">&#x27;tmp/lrg.csv&#x27;</span></span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建一个csv用于保存图像名和分类</span></span><br><span class="line">df = pd.DataFrame(&#123;<span class="string">&#x27;fn&#x27;</span>:[trn_fns[o] <span class="keyword">for</span> o <span class="keyword">in</span> trn_ids],</span><br><span class="line">                      <span class="string">&#x27;cat&#x27;</span>:[cats[trn_lrg_anno[o][<span class="number">1</span>]] <span class="keyword">for</span> o <span class="keyword">in</span> trn_ids]&#125;, columns=[<span class="string">&#x27;fn&#x27;</span>,<span class="string">&#x27;cat&#x27;</span>])</span><br><span class="line">df.to_csv(CSV, index=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<h3 id="分类模型和训练"><a href="#分类模型和训练" class="headerlink" title="分类模型和训练"></a>分类模型和训练</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 模型选择和超参数设置</span></span><br><span class="line">f_model = resnet34</span><br><span class="line">sz = <span class="number">224</span></span><br><span class="line">bs = <span class="number">64</span></span><br></pre></td></tr></table></figure>

<p>之所以要用CropType.NO是因为不像ImageNet那种数据（图像中主要目标在画面中心），Pascal数据集中很多情况下，目标又小，且在画面边缘，因此centerCrop会影响数据增强的实际效果。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># transformer和数据集</span></span><br><span class="line">tfms = tfms_from_model(f_model=f_model, sz=sz, aug_tfms=transforms_side_on, crop_type=CropType.NO)</span><br><span class="line">md = ImageClassifierData.from_csv(path=PATH, folder=JPEGS, csv_fname=CSV, tfms=tfms, bs=bs)</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">x,y = <span class="built_in">next</span>(<span class="built_in">iter</span>(md.val_dl))</span><br></pre></td></tr></table></figure>

<p>所有ImageNet预训练的模型，都对数据输入做了Normalize处理（0均值1方差），因此想要得到正常的图像，需要进行逆归一化处理。</p>
<p>fast.ai提供了denorm方法。同时记得将GPU中的数据移到CPU的numpy中。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show_img(md.val_ds.denorm(to_np(x))[<span class="number">0</span>]);</span><br></pre></td></tr></table></figure>


<p><img data-src="https://res.cloudinary.com/dgchmgebr/image/upload/v1678509742/blog/h7yisnzcekepxotzgerz.png" alt="png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 学习器设置和优化策略</span></span><br><span class="line">learn = ConvLearner.pretrained(f=f_model, data=md, metrics=[accuracy])</span><br><span class="line">learn.opt_fn = optim.Adam</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 寻找最优lr</span></span><br><span class="line">lrf=learn.lr_find(<span class="number">1e-5</span>,<span class="number">100</span>)</span><br><span class="line">learn.sched.plot()</span><br></pre></td></tr></table></figure>


<pre><code>HBox(children=(IntProgress(value=0, description=&#39;Epoch&#39;, max=1), HTML(value=&#39;&#39;)))


 78%|███████▊  | 25/32 [00:05&lt;00:00,  7.78it/s, loss=5.06]
                                                          
</code></pre>
<p><img data-src="https://res.cloudinary.com/dgchmgebr/image/upload/v1678509743/blog/okod4sybtznuepgyt9it.png" alt="png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">learn.sched.plot(n_skip=<span class="number">5</span>, n_skip_end=<span class="number">1</span>)</span><br></pre></td></tr></table></figure>


<p><img data-src="https://res.cloudinary.com/dgchmgebr/image/upload/v1678509743/blog/gdxlivbrq94n6j1wypa3.png" alt="png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 确认lr=2e-2</span></span><br><span class="line">lr = <span class="number">2e-2</span></span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">learn.fit(lr, <span class="number">1</span>, cycle_len=<span class="number">1</span>)</span><br></pre></td></tr></table></figure>


<pre><code>HBox(children=(IntProgress(value=0, description=&#39;Epoch&#39;, max=1), HTML(value=&#39;&#39;)))


epoch      trn_loss   val_loss   accuracy                 
    0      1.252253   0.738965   0.766     






[array([0.73897]), 0.7660000019073486]
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置differencial learning rate</span></span><br><span class="line">lrs = np.array([lr/<span class="number">1000</span>,lr/<span class="number">100</span>,lr])</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 解锁最后两层</span></span><br><span class="line">learn.freeze_to(-<span class="number">2</span>)</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lrf=learn.lr_find(start_lr=lrs/<span class="number">1000</span>)</span><br><span class="line">learn.sched.plot(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>


<pre><code>HBox(children=(IntProgress(value=0, description=&#39;Epoch&#39;, max=1), HTML(value=&#39;&#39;)))


 84%|████████▍ | 27/32 [00:07&lt;00:01,  4.02it/s, loss=2.05] 
                                                          
</code></pre>
<p><img data-src="https://res.cloudinary.com/dgchmgebr/image/upload/v1678509744/blog/h5npa7nchalbd0e2b5xf.png" alt="png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">learn.fit(lrs/<span class="number">5</span>, <span class="number">1</span>, cycle_len=<span class="number">1</span>)</span><br></pre></td></tr></table></figure>


<pre><code>HBox(children=(IntProgress(value=0, description=&#39;Epoch&#39;, max=1), HTML(value=&#39;&#39;)))


epoch      trn_loss   val_loss   accuracy                  
    0      0.761318   0.678066   0.772     






[array([0.67807]), 0.7720000019073486]
</code></pre>
<p>准确率不高可能是因为图像中有很多明显的目标，所以没有单分类时的图像识别的准确率高</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">learn.unfreeze()</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">learn.fit(lrs/<span class="number">5</span>, <span class="number">1</span>, cycle_len=<span class="number">2</span>)</span><br></pre></td></tr></table></figure>


<pre><code>HBox(children=(IntProgress(value=0, description=&#39;Epoch&#39;, max=2), HTML(value=&#39;&#39;)))


epoch      trn_loss   val_loss   accuracy                  
    0      0.598608   0.650308   0.794     
    1      0.429849   0.63418    0.798                     






[array([0.63418]), 0.7980000004768372]
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 模型保存和加载</span></span><br><span class="line">learn.save(<span class="string">&#x27;clas_one&#x27;</span>)</span><br><span class="line">learn.load(<span class="string">&#x27;clas_one&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="分类测试"><a href="#分类测试" class="headerlink" title="分类测试"></a>分类测试</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进行一个batch的测试</span></span><br><span class="line">x,y = <span class="built_in">next</span>(<span class="built_in">iter</span>(md.val_dl))</span><br><span class="line">probs = F.softmax(predict_batch(learn.model, x), -<span class="number">1</span>)</span><br><span class="line">X,preds = to_np(x), to_np(probs)</span><br><span class="line">preds = np.argmax(preds, -<span class="number">1</span>)</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 绘制分类结果</span></span><br><span class="line">fig,axes = plt.subplots(<span class="number">3</span>,<span class="number">4</span>, figsize = (<span class="number">16</span>,<span class="number">12</span>))</span><br><span class="line"><span class="keyword">for</span> i,ax <span class="keyword">in</span> <span class="built_in">enumerate</span>(axes.flat):</span><br><span class="line">    ima = md.val_ds.denorm(x)[i]</span><br><span class="line">    b = md.classes[preds[i]]</span><br><span class="line">    ax = show_img(ima, ax = ax)</span><br><span class="line">    draw_text(ax, (<span class="number">0</span>,<span class="number">0</span>),b)</span><br><span class="line">plt.tight_layout</span><br></pre></td></tr></table></figure>

<pre><code>WARNING:matplotlib.image:Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).





&lt;function matplotlib.pyplot.tight_layout(pad=1.08, h_pad=None, w_pad=None, rect=None)&gt;
</code></pre>
<p><img data-src="https://res.cloudinary.com/dgchmgebr/image/upload/v1678509745/blog/tsgncviwit6tugulvqop.png" alt="png"></p>
<h2 id="BBox预测"><a href="#BBox预测" class="headerlink" title="BBox预测"></a>BBox预测</h2><p>寻找最大物体的bounding box, 只是用简单的回归预测，（4输出）。</p>
<h3 id="创建BBox的CSV文件"><a href="#创建BBox的CSV文件" class="headerlink" title="创建BBox的CSV文件"></a>创建BBox的CSV文件</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建一个具有多标签的CSV文件</span></span><br><span class="line">BB_CSV = PATH/<span class="string">&#x27;tmp/bb.csv&#x27;</span></span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bb = np.array([trn_lrg_anno[o][<span class="number">0</span>] <span class="keyword">for</span> o <span class="keyword">in</span> trn_ids])</span><br><span class="line">bbs = [<span class="string">&#x27; &#x27;</span>.join(<span class="built_in">str</span>(p) <span class="keyword">for</span> p <span class="keyword">in</span> o) <span class="keyword">for</span> o <span class="keyword">in</span> bb]</span><br><span class="line"></span><br><span class="line">df = pd.DataFrame(&#123;<span class="string">&#x27;fn&#x27;</span>:[trn_fns[o] <span class="keyword">for</span> o <span class="keyword">in</span> trn_ids], <span class="string">&#x27;bbox&#x27;</span>: bbs&#125;, columns=[<span class="string">&#x27;fn&#x27;</span>,<span class="string">&#x27;bbox&#x27;</span>])</span><br><span class="line">df.to_csv(BB_CSV, index=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BB_CSV.<span class="built_in">open</span>().readlines()[:<span class="number">5</span>]</span><br></pre></td></tr></table></figure>




<pre><code>[&#39;fn,bbox\n&#39;,
 &#39;008197.jpg,186 450 226 496\n&#39;,
 &#39;008199.jpg,84 363 374 498\n&#39;,
 &#39;008202.jpg,110 190 371 457\n&#39;,
 &#39;008203.jpg,187 37 359 303\n&#39;]
</code></pre>
<h3 id="模型和训练"><a href="#模型和训练" class="headerlink" title="模型和训练"></a>模型和训练</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置模型和超参数</span></span><br><span class="line">f_model = resnet34</span><br><span class="line">sz = <span class="number">224</span></span><br><span class="line">bs = <span class="number">64</span></span><br></pre></td></tr></table></figure>

<h4 id="Data-Augmentation"><a href="#Data-Augmentation" class="headerlink" title="Data Augmentation"></a>Data Augmentation</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 自定义数据增广方式</span></span><br><span class="line">augs = [RandomFlip(), </span><br><span class="line">        RandomRotate(<span class="number">30</span>),</span><br><span class="line">        RandomLighting(<span class="number">0.1</span>,<span class="number">0.1</span>)]</span><br></pre></td></tr></table></figure>

<p>设置<code>continuous=True</code>是为了设置fastai处理一个回归问题，这个状态下，标签数据将不会被热编码。同时采用MSE作为默认的评估函数。</p>
<p>设置<code>CropType.NO</code>是因为想要将矩形的图像压成正方形的图像，而不是采用center cropping, 采用center cropping可能会丢失目标。因为这是多目标图像，而不是类似ImageNet的单目标图像。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tfms = tfms_from_model(f_model=f_model, sz=sz, aug_tfms=augs, crop_type=CropType.NO)</span><br><span class="line">md = ImageClassifierData.from_csv(path=PATH, folder=JPEGS, csv_fname=BB_CSV, tfms=tfms, continuous=<span class="literal">True</span>, bs= bs)</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 测试数据增广</span></span><br><span class="line">idx = <span class="number">5</span></span><br><span class="line">fig,axes = plt.subplots(ncols=<span class="number">3</span>,nrows=<span class="number">3</span>,figsize=(<span class="number">9</span>,<span class="number">9</span>))</span><br><span class="line"><span class="keyword">for</span> i,ax <span class="keyword">in</span> <span class="built_in">enumerate</span>(axes.flat):</span><br><span class="line">    x,y = <span class="built_in">next</span>(<span class="built_in">iter</span>(md.aug_dl))</span><br><span class="line">    ima = md.val_ds.denorm(to_np(x))[idx]</span><br><span class="line">    b = bb_hw(to_np(y[idx]))</span><br><span class="line">    <span class="built_in">print</span>(b)</span><br><span class="line">    show_img(ima,ax=ax)</span><br><span class="line">    draw_rect(ax, b)</span><br></pre></td></tr></table></figure>

<pre><code>[ 51. 102. 449. 222.]
[ 51. 102. 449. 222.]
[ 51. 102. 449. 222.]
[ 51. 102. 449. 222.]
[ 51. 102. 449. 222.]
[ 51. 102. 449. 222.]
[ 51. 102. 449. 222.]
[ 51. 102. 449. 222.]
[ 51. 102. 449. 222.]
</code></pre>
<p><img data-src="https://res.cloudinary.com/dgchmgebr/image/upload/v1678509748/blog/p0mv71xeeadjdupfc6ci.png" alt="png"></p>
<p>上图可知框的增强方式不可以，扩增的bbox并不能包围住目标。</p>
<p>按照fast.ai作者的说法是需要指定transform的类型为坐标类型（tfmType.COORD）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 数据增强，注意由于bbox的坐标属性，要指定COORD类型</span></span><br><span class="line">augs = [RandomFlip(tfm_y=TfmType.COORD),</span><br><span class="line">        RandomRotate(<span class="number">30</span>, tfm_y=TfmType.COORD),</span><br><span class="line">        RandomLighting(<span class="number">0.1</span>,<span class="number">0.1</span>, tfm_y=TfmType.COORD)]</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tfms = tfms_from_model(f_model=f_model, sz=sz, aug_tfms=augs, crop_type=CropType.NO, tfm_y=TfmType.COORD)</span><br><span class="line">md = ImageClassifierData.from_csv(path=PATH, folder=JPEGS, csv_fname=BB_CSV, tfms=tfms, continuous=<span class="literal">True</span>, bs= bs)</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 测试数据增广</span></span><br><span class="line">idx = <span class="number">5</span></span><br><span class="line">fig,axes = plt.subplots(ncols=<span class="number">3</span>,nrows=<span class="number">3</span>,figsize=(<span class="number">9</span>,<span class="number">9</span>))</span><br><span class="line"><span class="keyword">for</span> i,ax <span class="keyword">in</span> <span class="built_in">enumerate</span>(axes.flat):</span><br><span class="line">    x,y = <span class="built_in">next</span>(<span class="built_in">iter</span>(md.aug_dl))</span><br><span class="line">    ima = md.val_ds.denorm(to_np(x))[idx]</span><br><span class="line">    b = bb_hw(to_np(y[idx]))</span><br><span class="line">    <span class="built_in">print</span>(b)</span><br><span class="line">    show_img(ima,ax=ax)</span><br><span class="line">    draw_rect(ax, b)</span><br></pre></td></tr></table></figure>

<pre><code>[  0.  59. 204. 164.]
[ 18.  58. 206. 165.]
[ 11.  42. 213. 181.]
[  1.  69. 199. 146.]
[  7.  31. 217. 192.]
[  0.   7. 204. 216.]
[  0.  27. 204. 196.]
[  0.  45. 203. 178.]
[ 20.   0. 204. 223.]
</code></pre>
<p><img data-src="https://res.cloudinary.com/dgchmgebr/image/upload/v1678509749/blog/a9jodajzh8bgdpjpymvu.png" alt="png"></p>
<p>这样的增强方式是对的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 重新设置扩增参数</span></span><br><span class="line">tfm_y = TfmType.COORD</span><br><span class="line">augs = [RandomFlip(tfm_y=tfm_y),</span><br><span class="line">        RandomRotate(<span class="number">3</span>, p=<span class="number">0.5</span>, tfm_y=tfm_y), <span class="comment"># 考虑到旋转后的BBOx得到的方式，角度不能过大。过大会引起目标不在BBOX中</span></span><br><span class="line">        RandomLighting(<span class="number">0.05</span>,<span class="number">0.05</span>, tfm_y=tfm_y)]</span><br><span class="line"></span><br><span class="line">tfms = tfms_from_model(f_model, sz, crop_type=CropType.NO, tfm_y=tfm_y, aug_tfms=augs)</span><br><span class="line">md = ImageClassifierData.from_csv(PATH, JPEGS, BB_CSV, tfms=tfms, bs=bs, continuous=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<h4 id="自定义-网络层"><a href="#自定义-网络层" class="headerlink" title="自定义 网络层"></a>自定义 网络层</h4><p>fast.ai 允许使用<code>custom_head</code>在卷积层之后添加自定义模块，而不是默认的adaptive pooling层和全连接层。</p>
<p>在本实验中，由于需要知道每个格点的activation强度，因此不能做池化。</p>
<p>最后一层有四个activations, 每个bbox的坐标。由于目标是连续的，而不是分类的，所以所以MSE损失函数并无帮助。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">512</span>*<span class="number">7</span>*<span class="number">7</span></span><br></pre></td></tr></table></figure>




<pre><code>25088
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">head_reg4 = nn.Sequential(Flatten(), nn.Linear(<span class="number">25088</span>, <span class="number">4</span>))</span><br><span class="line">learn = ConvLearner.pretrained(f_model, md, custom_head=head_reg4)</span><br><span class="line">learn.opt_fn = optim.Adam</span><br><span class="line">learn.crit = nn.L1Loss() <span class="comment"># 采用L1进行坐标预测的损失计算</span></span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看模型</span></span><br><span class="line">learn.summary()</span><br></pre></td></tr></table></figure>




<pre><code>OrderedDict([(&#39;Conv2d-1&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 3, 224, 224]),
                           (&#39;output_shape&#39;, [-1, 64, 112, 112]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 9408)])),
             (&#39;BatchNorm2d-2&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 64, 112, 112]),
                           (&#39;output_shape&#39;, [-1, 64, 112, 112]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 128)])),
             (&#39;ReLU-3&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 64, 112, 112]),
                           (&#39;output_shape&#39;, [-1, 64, 112, 112]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;MaxPool2d-4&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 64, 112, 112]),
                           (&#39;output_shape&#39;, [-1, 64, 56, 56]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;Conv2d-5&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 64, 56, 56]),
                           (&#39;output_shape&#39;, [-1, 64, 56, 56]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 36864)])),
             (&#39;BatchNorm2d-6&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 64, 56, 56]),
                           (&#39;output_shape&#39;, [-1, 64, 56, 56]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 128)])),
             (&#39;ReLU-7&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 64, 56, 56]),
                           (&#39;output_shape&#39;, [-1, 64, 56, 56]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;Conv2d-8&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 64, 56, 56]),
                           (&#39;output_shape&#39;, [-1, 64, 56, 56]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 36864)])),
             (&#39;BatchNorm2d-9&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 64, 56, 56]),
                           (&#39;output_shape&#39;, [-1, 64, 56, 56]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 128)])),
             (&#39;ReLU-10&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 64, 56, 56]),
                           (&#39;output_shape&#39;, [-1, 64, 56, 56]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;BasicBlock-11&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 64, 56, 56]),
                           (&#39;output_shape&#39;, [-1, 64, 56, 56]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;Conv2d-12&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 64, 56, 56]),
                           (&#39;output_shape&#39;, [-1, 64, 56, 56]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 36864)])),
             (&#39;BatchNorm2d-13&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 64, 56, 56]),
                           (&#39;output_shape&#39;, [-1, 64, 56, 56]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 128)])),
             (&#39;ReLU-14&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 64, 56, 56]),
                           (&#39;output_shape&#39;, [-1, 64, 56, 56]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;Conv2d-15&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 64, 56, 56]),
                           (&#39;output_shape&#39;, [-1, 64, 56, 56]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 36864)])),
             (&#39;BatchNorm2d-16&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 64, 56, 56]),
                           (&#39;output_shape&#39;, [-1, 64, 56, 56]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 128)])),
             (&#39;ReLU-17&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 64, 56, 56]),
                           (&#39;output_shape&#39;, [-1, 64, 56, 56]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;BasicBlock-18&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 64, 56, 56]),
                           (&#39;output_shape&#39;, [-1, 64, 56, 56]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;Conv2d-19&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 64, 56, 56]),
                           (&#39;output_shape&#39;, [-1, 64, 56, 56]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 36864)])),
             (&#39;BatchNorm2d-20&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 64, 56, 56]),
                           (&#39;output_shape&#39;, [-1, 64, 56, 56]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 128)])),
             (&#39;ReLU-21&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 64, 56, 56]),
                           (&#39;output_shape&#39;, [-1, 64, 56, 56]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;Conv2d-22&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 64, 56, 56]),
                           (&#39;output_shape&#39;, [-1, 64, 56, 56]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 36864)])),
             (&#39;BatchNorm2d-23&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 64, 56, 56]),
                           (&#39;output_shape&#39;, [-1, 64, 56, 56]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 128)])),
             (&#39;ReLU-24&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 64, 56, 56]),
                           (&#39;output_shape&#39;, [-1, 64, 56, 56]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;BasicBlock-25&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 64, 56, 56]),
                           (&#39;output_shape&#39;, [-1, 64, 56, 56]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;Conv2d-26&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 64, 56, 56]),
                           (&#39;output_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 73728)])),
             (&#39;BatchNorm2d-27&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;output_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 256)])),
             (&#39;ReLU-28&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;output_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;Conv2d-29&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;output_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 147456)])),
             (&#39;BatchNorm2d-30&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;output_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 256)])),
             (&#39;Conv2d-31&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 64, 56, 56]),
                           (&#39;output_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 8192)])),
             (&#39;BatchNorm2d-32&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;output_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 256)])),
             (&#39;ReLU-33&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;output_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;BasicBlock-34&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 64, 56, 56]),
                           (&#39;output_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;Conv2d-35&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;output_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 147456)])),
             (&#39;BatchNorm2d-36&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;output_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 256)])),
             (&#39;ReLU-37&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;output_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;Conv2d-38&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;output_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 147456)])),
             (&#39;BatchNorm2d-39&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;output_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 256)])),
             (&#39;ReLU-40&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;output_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;BasicBlock-41&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;output_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;Conv2d-42&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;output_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 147456)])),
             (&#39;BatchNorm2d-43&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;output_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 256)])),
             (&#39;ReLU-44&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;output_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;Conv2d-45&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;output_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 147456)])),
             (&#39;BatchNorm2d-46&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;output_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 256)])),
             (&#39;ReLU-47&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;output_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;BasicBlock-48&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;output_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;Conv2d-49&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;output_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 147456)])),
             (&#39;BatchNorm2d-50&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;output_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 256)])),
             (&#39;ReLU-51&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;output_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;Conv2d-52&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;output_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 147456)])),
             (&#39;BatchNorm2d-53&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;output_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 256)])),
             (&#39;ReLU-54&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;output_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;BasicBlock-55&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;output_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;Conv2d-56&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;output_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 294912)])),
             (&#39;BatchNorm2d-57&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;output_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 512)])),
             (&#39;ReLU-58&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;output_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;Conv2d-59&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;output_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 589824)])),
             (&#39;BatchNorm2d-60&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;output_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 512)])),
             (&#39;Conv2d-61&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;output_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 32768)])),
             (&#39;BatchNorm2d-62&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;output_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 512)])),
             (&#39;ReLU-63&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;output_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;BasicBlock-64&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 128, 28, 28]),
                           (&#39;output_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;Conv2d-65&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;output_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 589824)])),
             (&#39;BatchNorm2d-66&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;output_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 512)])),
             (&#39;ReLU-67&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;output_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;Conv2d-68&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;output_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 589824)])),
             (&#39;BatchNorm2d-69&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;output_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 512)])),
             (&#39;ReLU-70&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;output_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;BasicBlock-71&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;output_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;Conv2d-72&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;output_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 589824)])),
             (&#39;BatchNorm2d-73&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;output_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 512)])),
             (&#39;ReLU-74&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;output_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;Conv2d-75&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;output_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 589824)])),
             (&#39;BatchNorm2d-76&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;output_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 512)])),
             (&#39;ReLU-77&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;output_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;BasicBlock-78&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;output_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;Conv2d-79&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;output_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 589824)])),
             (&#39;BatchNorm2d-80&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;output_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 512)])),
             (&#39;ReLU-81&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;output_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;Conv2d-82&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;output_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 589824)])),
             (&#39;BatchNorm2d-83&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;output_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 512)])),
             (&#39;ReLU-84&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;output_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;BasicBlock-85&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;output_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;Conv2d-86&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;output_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 589824)])),
             (&#39;BatchNorm2d-87&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;output_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 512)])),
             (&#39;ReLU-88&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;output_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;Conv2d-89&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;output_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 589824)])),
             (&#39;BatchNorm2d-90&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;output_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 512)])),
             (&#39;ReLU-91&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;output_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;BasicBlock-92&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;output_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;Conv2d-93&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;output_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 589824)])),
             (&#39;BatchNorm2d-94&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;output_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 512)])),
             (&#39;ReLU-95&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;output_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;Conv2d-96&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;output_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 589824)])),
             (&#39;BatchNorm2d-97&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;output_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 512)])),
             (&#39;ReLU-98&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;output_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;BasicBlock-99&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;output_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;Conv2d-100&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;output_shape&#39;, [-1, 512, 7, 7]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 1179648)])),
             (&#39;BatchNorm2d-101&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 512, 7, 7]),
                           (&#39;output_shape&#39;, [-1, 512, 7, 7]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 1024)])),
             (&#39;ReLU-102&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 512, 7, 7]),
                           (&#39;output_shape&#39;, [-1, 512, 7, 7]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;Conv2d-103&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 512, 7, 7]),
                           (&#39;output_shape&#39;, [-1, 512, 7, 7]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 2359296)])),
             (&#39;BatchNorm2d-104&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 512, 7, 7]),
                           (&#39;output_shape&#39;, [-1, 512, 7, 7]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 1024)])),
             (&#39;Conv2d-105&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;output_shape&#39;, [-1, 512, 7, 7]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 131072)])),
             (&#39;BatchNorm2d-106&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 512, 7, 7]),
                           (&#39;output_shape&#39;, [-1, 512, 7, 7]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 1024)])),
             (&#39;ReLU-107&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 512, 7, 7]),
                           (&#39;output_shape&#39;, [-1, 512, 7, 7]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;BasicBlock-108&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 256, 14, 14]),
                           (&#39;output_shape&#39;, [-1, 512, 7, 7]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;Conv2d-109&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 512, 7, 7]),
                           (&#39;output_shape&#39;, [-1, 512, 7, 7]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 2359296)])),
             (&#39;BatchNorm2d-110&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 512, 7, 7]),
                           (&#39;output_shape&#39;, [-1, 512, 7, 7]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 1024)])),
             (&#39;ReLU-111&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 512, 7, 7]),
                           (&#39;output_shape&#39;, [-1, 512, 7, 7]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;Conv2d-112&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 512, 7, 7]),
                           (&#39;output_shape&#39;, [-1, 512, 7, 7]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 2359296)])),
             (&#39;BatchNorm2d-113&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 512, 7, 7]),
                           (&#39;output_shape&#39;, [-1, 512, 7, 7]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 1024)])),
             (&#39;ReLU-114&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 512, 7, 7]),
                           (&#39;output_shape&#39;, [-1, 512, 7, 7]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;BasicBlock-115&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 512, 7, 7]),
                           (&#39;output_shape&#39;, [-1, 512, 7, 7]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;Conv2d-116&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 512, 7, 7]),
                           (&#39;output_shape&#39;, [-1, 512, 7, 7]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 2359296)])),
             (&#39;BatchNorm2d-117&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 512, 7, 7]),
                           (&#39;output_shape&#39;, [-1, 512, 7, 7]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 1024)])),
             (&#39;ReLU-118&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 512, 7, 7]),
                           (&#39;output_shape&#39;, [-1, 512, 7, 7]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;Conv2d-119&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 512, 7, 7]),
                           (&#39;output_shape&#39;, [-1, 512, 7, 7]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 2359296)])),
             (&#39;BatchNorm2d-120&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 512, 7, 7]),
                           (&#39;output_shape&#39;, [-1, 512, 7, 7]),
                           (&#39;trainable&#39;, False),
                           (&#39;nb_params&#39;, 1024)])),
             (&#39;ReLU-121&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 512, 7, 7]),
                           (&#39;output_shape&#39;, [-1, 512, 7, 7]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;BasicBlock-122&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 512, 7, 7]),
                           (&#39;output_shape&#39;, [-1, 512, 7, 7]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;Flatten-123&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 512, 7, 7]),
                           (&#39;output_shape&#39;, [-1, 25088]),
                           (&#39;nb_params&#39;, 0)])),
             (&#39;Linear-124&#39;,
              OrderedDict([(&#39;input_shape&#39;, [-1, 25088]),
                           (&#39;output_shape&#39;, [-1, 4]),
                           (&#39;trainable&#39;, True),
                           (&#39;nb_params&#39;, 100356)]))])
</code></pre>
<h4 id="训练"><a href="#训练" class="headerlink" title="训练"></a>训练</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 最优学习率</span></span><br><span class="line">learn.lr_find(<span class="number">1e-5</span>,<span class="number">100</span>)</span><br><span class="line">learn.sched.plot(<span class="number">5</span>)</span><br></pre></td></tr></table></figure>


<pre><code>HBox(children=(IntProgress(value=0, description=&#39;Epoch&#39;, max=1), HTML(value=&#39;&#39;)))


 78%|███████▊  | 25/32 [00:07&lt;00:02,  2.74it/s, loss=361] 
                                                         
</code></pre>
<p><img data-src="https://res.cloudinary.com/dgchmgebr/image/upload/v1678509749/blog/wvjvaehmny7u4znu4ohy.png" alt="png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 确认学习率</span></span><br><span class="line">lr = <span class="number">2e-3</span></span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">learn.fit(lr, <span class="number">2</span>,cycle_len=<span class="number">1</span>,cycle_mult=<span class="number">2</span>)</span><br></pre></td></tr></table></figure>


<pre><code>HBox(children=(IntProgress(value=0, description=&#39;Epoch&#39;, max=3), HTML(value=&#39;&#39;)))


epoch      trn_loss   val_loss                            
    0      47.500094  35.377468 
    1      36.438239  30.041442                           
    2      31.159879  28.646647                           






[array([28.64665])]
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># differencial Learning rate</span></span><br><span class="line">lrs = np.array([lr/<span class="number">100</span>,lr/<span class="number">10</span>,lr])</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">learn.freeze_to(-<span class="number">2</span>)</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lrf=learn.lr_find(lrs/<span class="number">1000</span>)</span><br><span class="line">learn.sched.plot(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>


<pre><code>HBox(children=(IntProgress(value=0, description=&#39;Epoch&#39;, max=1), HTML(value=&#39;&#39;)))


epoch      trn_loss   val_loss                            
    0      74.022108  27465245354098.688
</code></pre>
<p><img data-src="https://res.cloudinary.com/dgchmgebr/image/upload/v1678509750/blog/wlblzwpsduyqtqbbcwgz.png" alt="png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">learn.fit(lrs, <span class="number">2</span>, cycle_len=<span class="number">1</span>, cycle_mult=<span class="number">2</span>)</span><br></pre></td></tr></table></figure>


<pre><code>HBox(children=(IntProgress(value=0, description=&#39;Epoch&#39;, max=3), HTML(value=&#39;&#39;)))


epoch      trn_loss   val_loss                            
    0      25.365956  24.037737 
    1      22.525828  22.351341                           
    2      19.34687   21.012311                           






[array([21.01231])]
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">learn.freeze_to(-<span class="number">3</span>)</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">learn.fit(lrs, <span class="number">1</span>, cycle_len=<span class="number">2</span>)</span><br></pre></td></tr></table></figure>


<pre><code>HBox(children=(IntProgress(value=0, description=&#39;Epoch&#39;, max=2), HTML(value=&#39;&#39;)))


epoch      trn_loss   val_loss                            
    0      17.857246  21.15573  
    1      15.792291  20.153743                           






[array([20.15374])]
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">learn.save(<span class="string">&#x27;reg4&#x27;</span>)</span><br><span class="line">learn.load(<span class="string">&#x27;reg4&#x27;</span>)</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 预测一个batch</span></span><br><span class="line">x,y = <span class="built_in">next</span>(<span class="built_in">iter</span>(md.val_dl))</span><br><span class="line">learn.model.<span class="built_in">eval</span>()</span><br><span class="line">preds = to_np(learn.model(VV(x)))</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 绘制预测结果</span></span><br><span class="line">fig, axes = plt.subplots(<span class="number">3</span>, <span class="number">4</span>, figsize=(<span class="number">12</span>, <span class="number">8</span>))</span><br><span class="line"><span class="keyword">for</span> i,ax <span class="keyword">in</span> <span class="built_in">enumerate</span>(axes.flat):</span><br><span class="line">    ima=md.val_ds.denorm(to_np(x))[i]</span><br><span class="line">    b = bb_hw(preds[i])</span><br><span class="line">    ax = show_img(ima, ax=ax)</span><br><span class="line">    draw_rect(ax, b)</span><br><span class="line">plt.tight_layout()</span><br></pre></td></tr></table></figure>

<pre><code>WARNING:matplotlib.image:Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).
</code></pre>
<p><img data-src="https://res.cloudinary.com/dgchmgebr/image/upload/v1678509751/blog/hqgm6vs0ju5tmkk8axcc.png" alt="png"></p>
<h2 id="单目标检测"><a href="#单目标检测" class="headerlink" title="单目标检测"></a>单目标检测</h2><p>对于训练一个神经网络来说，最重要的就是三点</p>
<ol>
<li>数据</li>
<li>网络结构</li>
<li>损失函数</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置模型和超参数</span></span><br><span class="line">f_model = resnet34</span><br><span class="line">sz = <span class="number">224</span></span><br><span class="line">bs = <span class="number">64</span></span><br><span class="line"></span><br><span class="line">val_idxs = get_cv_idxs(<span class="built_in">len</span>(trn_fns)) <span class="comment"># 生成验证集</span></span><br></pre></td></tr></table></figure>

<h3 id="数据"><a href="#数据" class="headerlink" title="数据"></a>数据</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置transformer和dataset</span></span><br><span class="line">tfms = tfms_from_model(f_model, sz, crop_type=CropType.NO, tfm_y=TfmType.COORD,aug_tfms=augs)</span><br><span class="line"><span class="comment"># bbox的dataset</span></span><br><span class="line">md = ImageClassifierData.from_csv(PATH, JPEGS, BB_CSV,tfms=tfms, bs=bs, continuous=<span class="literal">True</span>, val_idxs=val_idxs)</span><br><span class="line"><span class="comment"># 分类的dataset</span></span><br><span class="line">md2 = ImageClassifierData.from_csv(PATH, JPEGS, CSV, tfms=tfms_from_model(f_model=f_model, sz=sz))</span><br></pre></td></tr></table></figure>

<p>dataset类可以根据<code>__len__</code>和<code>__getitem__</code>来自定义。</p>
<p>向已有dataset添加第二个label，由此构建一个同时包含BBox和标签的数据集。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ConcatLblDataset</span>(<span class="title class_ inherited__">Dataset</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, ds, y2</span>):</span><br><span class="line">        self.ds = ds</span><br><span class="line">        self.y2 = y2</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__len__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(self.ds)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, i</span>):</span><br><span class="line">        x, y = self.ds[i]</span><br><span class="line">        <span class="keyword">return</span> (x, (y, self.y2[i]))</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 向已有的bboxdataset中添加分类dataset</span></span><br><span class="line">trn_ds2 = ConcatLblDataset(md.trn_ds, md2.trn_y)</span><br><span class="line">val_ds2 = ConcatLblDataset(md.val_ds,md2.val_y)</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">val_ds2[<span class="number">0</span>][<span class="number">1</span>]</span><br></pre></td></tr></table></figure>




<pre><code>(array([  0.,   1., 223., 178.], dtype=float32), 14)
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 替换得到新的dataset</span></span><br><span class="line">md.trn_dl.dataset = trn_ds2</span><br><span class="line">md.val_dl.dataset = val_ds2</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看新的dataset是否正常</span></span><br><span class="line">x,y = <span class="built_in">next</span>(<span class="built_in">iter</span>(md.val_dl)) <span class="comment"># 取一个batch</span></span><br><span class="line">idx = <span class="number">3</span></span><br><span class="line">ima = md.val_ds.ds.denorm(to_np(x))[idx] <span class="comment"># 取dataset中ds(即bbox数据集)</span></span><br><span class="line">b = bb_hw(to_np(y[<span class="number">0</span>][idx]));</span><br><span class="line">b</span><br></pre></td></tr></table></figure>




<pre><code>array([  1.,  60., 223., 127.])
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ax = show_img(ima)</span><br><span class="line">draw_rect(ax, b)</span><br><span class="line">draw_text(ax, b[:<span class="number">2</span>], md2.classes[y[<span class="number">1</span>][idx]]) <span class="comment"># 取y[1]即y2即分类标签</span></span><br></pre></td></tr></table></figure>


<p><img data-src="https://res.cloudinary.com/dgchmgebr/image/upload/v1678509753/blog/pbtycrbhcg4cvhvyj1it.png" alt="png"></p>
<h3 id="网络结构"><a href="#网络结构" class="headerlink" title="网络结构"></a>网络结构</h3><p>现在需要的输出是1. 各个类别的激活层（用于判断概率）和2. 生成每个bbox的坐标。</p>
<p>因此最后一层的activation具有4+C个。C表示类别数目.</p>
<p>这次使用线性层，然后加上dropout层提高可靠性。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 自定义高级输出层的结构</span></span><br><span class="line">head_reg4 = nn.Sequential(</span><br><span class="line">    Flatten(),</span><br><span class="line">    nn.ReLU(),</span><br><span class="line">    nn.Dropout(<span class="number">0.5</span>),</span><br><span class="line">    nn.Linear(<span class="number">25088</span>, <span class="number">256</span>),</span><br><span class="line">    nn.ReLU(),</span><br><span class="line">    nn.BatchNorm1d(<span class="number">256</span>),</span><br><span class="line">    nn.Dropout(<span class="number">0.5</span>),</span><br><span class="line">    nn.Linear(<span class="number">256</span>, <span class="number">4</span> + <span class="built_in">len</span>(cats)),</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用custom_head自定义卷积层后的结构</span></span><br><span class="line">models = ConvnetBuilder(f_model, <span class="number">0</span>, <span class="number">0</span>,<span class="number">0</span>,custom_head=head_reg4)</span><br><span class="line"></span><br><span class="line">learn = ConvLearner(md, models=models)</span><br><span class="line">learn.opt_fn = optim.Adam</span><br></pre></td></tr></table></figure>

<h3 id="损失函数"><a href="#损失函数" class="headerlink" title="损失函数"></a>损失函数</h3><p>定义损失函数和测量函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 损失函数是由bbox的l1_loss和分类的crossentropy共同计算得到的</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">detn_loss</span>(<span class="params"><span class="built_in">input</span>, target</span>):</span><br><span class="line">    bb_t, c_t = target <span class="comment"># goundTruth, 返回结构参考dataset的构造方式（get_item）</span></span><br><span class="line">    bb_i, c_i = <span class="built_in">input</span>[:, :<span class="number">4</span>], <span class="built_in">input</span>[:,<span class="number">4</span>:] <span class="comment"># activations</span></span><br><span class="line">    bb_i = F.sigmoid(bb_i) * <span class="number">224</span>  <span class="comment"># 图像size是224*224，sigmoid得到的是0-1之间的值，乘以224使之恢复成网络结构应该具有的大小范围</span></span><br><span class="line">    <span class="keyword">return</span> F.l1_loss(bb_i, bb_t) + F.cross_entropy(c_i, c_t)*<span class="number">20</span> <span class="comment"># 20是尺度需要，使两者尺度相当</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">detn_l1</span>(<span class="params"><span class="built_in">input</span>, target</span>):</span><br><span class="line">    bb_t, _ = target</span><br><span class="line">    bb_i = <span class="built_in">input</span>[:,:<span class="number">4</span>]</span><br><span class="line">    bb_i = F.sigmoid(bb_i) * <span class="number">224</span></span><br><span class="line">    <span class="keyword">return</span> F.l1_loss(V(bb_i),V(bb_t)).data</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">detn_acc</span>(<span class="params"><span class="built_in">input</span>, target</span>):</span><br><span class="line">    _,c_t = target</span><br><span class="line">    c_i = <span class="built_in">input</span>[:,<span class="number">4</span>:]</span><br><span class="line">    <span class="keyword">return</span> accuracy(c_i, c_t)</span><br><span class="line"></span><br><span class="line">learn.crit = detn_loss</span><br><span class="line">learn.metrics = [detn_acc, detn_l1]</span><br></pre></td></tr></table></figure>

<h3 id="训练-1"><a href="#训练-1" class="headerlink" title="训练"></a>训练</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 找最优lr</span></span><br><span class="line">learn.lr_find()</span><br><span class="line">learn.sched.plot()</span><br></pre></td></tr></table></figure>


<pre><code>HBox(children=(IntProgress(value=0, description=&#39;Epoch&#39;, max=1), HTML(value=&#39;&#39;)))


                                                         
</code></pre>
<p><img data-src="https://res.cloudinary.com/dgchmgebr/image/upload/v1678509753/blog/or6b2u4lg6zydboucjqx.png" alt="png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">learn.sched.plot(n_skip=<span class="number">5</span>, n_skip_end=<span class="number">1</span>)</span><br></pre></td></tr></table></figure>


<p><img data-src="https://res.cloudinary.com/dgchmgebr/image/upload/v1678509754/blog/tbopav0ye3eqp1w1zruu.png" alt="png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lr = <span class="number">1e-2</span></span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">learn.fit(lr, <span class="number">1</span>, cycle_len=<span class="number">3</span>, use_clr=(<span class="number">32</span>,<span class="number">5</span>))</span><br></pre></td></tr></table></figure>


<pre><code>HBox(children=(IntProgress(value=0, description=&#39;Epoch&#39;, max=3), HTML(value=&#39;&#39;)))


epoch      trn_loss   val_loss   detn_acc   detn_l1       
    0      73.021861  49.040769  0.762      33.868816 
    1      52.371605  39.897777  0.79       26.528015     
    2      43.085287  38.40951   0.782      25.693656     





[array([38.40951]), 0.7820000019073486, 25.693655502319334]
</code></pre>
<p>关于<code>use_clr</code>的含义，可以参考：<a target="_blank" rel="noopener" href="https://forums.fast.ai/t/understanding-use-clr/13969">Understanding use_clr</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">learn.save(<span class="string">&#x27;reg1_0&#x27;</span>)</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">learn.freeze_to(-<span class="number">2</span>)</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lrs = np.array([lr/<span class="number">100</span>, lr/<span class="number">10</span>, lr])</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">learn.lr_find(lrs/<span class="number">1000</span>)</span><br><span class="line">learn.sched.plot(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>


<pre><code>HBox(children=(IntProgress(value=0, description=&#39;Epoch&#39;, max=1), HTML(value=&#39;&#39;)))


                                                          
</code></pre>
<p><img data-src="https://res.cloudinary.com/dgchmgebr/image/upload/v1678509755/blog/tj4k0uaocg6f79egnuof.png" alt="png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">learn.fit(lrs/<span class="number">5</span>,<span class="number">1</span>,cycle_len=<span class="number">5</span>,use_clr=(<span class="number">32</span>,<span class="number">10</span>))</span><br></pre></td></tr></table></figure>


<pre><code>HBox(children=(IntProgress(value=0, description=&#39;Epoch&#39;, max=5), HTML(value=&#39;&#39;)))


epoch      trn_loss   val_loss   detn_acc   detn_l1       
    0      36.869526  38.903723  0.758      24.296154 
    1      31.326726  36.6155    0.766      21.896477     
    2      26.642102  33.09029   0.822      21.3755       
    3      23.477213  33.293454  0.804      21.018092     
    4      21.219933  32.841205  0.798      20.617818     





[array([32.84121]), 0.7979999985694886, 20.617818420410156]
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">learn.save(<span class="string">&#x27;reg1_1&#x27;</span>)</span><br><span class="line">learn.load(<span class="string">&#x27;reg1_1&#x27;</span>)</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">learn.unfreeze()</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 继续训练</span></span><br><span class="line">learn.fit(lrs/<span class="number">10</span>, <span class="number">1</span>, cycle_len=<span class="number">10</span>,use_clr=(<span class="number">32</span>,<span class="number">10</span>))</span><br></pre></td></tr></table></figure>


<pre><code>HBox(children=(IntProgress(value=0, description=&#39;Epoch&#39;, max=10), HTML(value=&#39;&#39;)))


epoch      trn_loss   val_loss   detn_acc   detn_l1       
    0      18.538771  33.337069  0.808      20.696491 
    1      18.376943  33.852231  0.784      20.624054     
    2      17.561372  33.20553   0.802      20.648081     
    3      16.458471  33.816986  0.786      20.271821     
    4      15.660971  33.647833  0.792      20.05454      
    5      14.905726  32.912299  0.784      19.615759     
    6      14.223394  32.798715  0.79       19.627963     
    7      13.683377  33.002606  0.788      19.551473     
    8      13.335879  32.818987  0.79       19.443868     
    9      13.039377  32.798003  0.784      19.413067     





[array([32.798]), 0.784000002861023, 19.413067443847655]
</code></pre>
<p>尽管80%的准确率不咋地，因为ResNet这个网络本身是用来进行分类的，而不是预测BBOX的回归预测的。</p>
<p><strong>同时，可以看到的是，在做准确率（分类问题）和BBox同时预测是，L1损失看起来比只做BBox预测要低。这是为何？</strong></p>
<p>这样来看，判断出图像中的主要的物体是什么是比较困难的步骤，然后再去判断主要物体的BBox和类别相比之下较为轻松。所以当有一个用于预测图中主要物体是什么以及BBox在哪时，它们会共享所有的计算，共享则意味着计算的高效，当进行分类误差与定位误差的反向传播时，共享的信息能够有助于找到图像中最大的物体。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">learn.save(<span class="string">&quot;reg1&quot;</span>)</span><br><span class="line">learn.load(<span class="string">&quot;reg1&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="预测"><a href="#预测" class="headerlink" title="预测"></a>预测</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 取一个batch进行验证</span></span><br><span class="line">y = learn.predict()</span><br><span class="line">x,_ = <span class="built_in">next</span>(<span class="built_in">iter</span>(md.val_dl))</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scipy.special <span class="keyword">import</span> expit</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">fig, axes = plt.subplots(<span class="number">3</span>,<span class="number">4</span>,figsize=(<span class="number">12</span>,<span class="number">8</span>))</span><br><span class="line"><span class="keyword">for</span> i,ax <span class="keyword">in</span> <span class="built_in">enumerate</span>(axes.flat):</span><br><span class="line">    ima = md.val_ds.ds.denorm(to_np(x))[i]</span><br><span class="line">    bb = expit(y[i][:<span class="number">4</span>])*<span class="number">224</span> <span class="comment"># expit就是logistic函数</span></span><br><span class="line">    b = bb_hw(bb) <span class="comment"># 转换为绘图用的bbox</span></span><br><span class="line">    c = np.argmax(y[i][<span class="number">4</span>:]) <span class="comment"># 得到分类ID</span></span><br><span class="line">    ax = show_img(ima, ax=ax)</span><br><span class="line">    draw_rect(ax, b) <span class="comment"># 画判断框</span></span><br><span class="line">    draw_text(ax, b[:<span class="number">2</span>], md2.classes[c]) <span class="comment"># 将分类结果写上</span></span><br><span class="line">plt.tight_layout()</span><br></pre></td></tr></table></figure>

<pre><code>WARNING:matplotlib.image:Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).
</code></pre>
<p><img data-src="https://res.cloudinary.com/dgchmgebr/image/upload/v1678509756/blog/naulhcykgbzjpsbxlifv.png" alt="png"></p>
<p>这次主要展示的MultiBox目标检测中的第一步：single object detection（单目标的检测，图像中单个主要的目标）。</p>
<p>可以看到存在的问题是，当出现群体目标时，BBox会框住群体中心区域，这显然是不对的。</p>
<h1 id="End"><a href="#End" class="headerlink" title="End"></a>End</h1>
    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>xiaohai
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://shenxiaohai.me/fastai-8-objctDetct/" title="在PASCAL VOC数据集上的单目标检测">https://shenxiaohai.me/fastai-8-objctDetct/</a>
  </li>
  <li class="post-copyright-license">
      <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%A7%86%E8%A7%89/" rel="tag"><i class="fa fa-tag"></i> 计算机视觉</a>
              <a href="/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" rel="tag"><i class="fa fa-tag"></i> 深度学习</a>
              <a href="/tags/PyTorch/" rel="tag"><i class="fa fa-tag"></i> PyTorch</a>
              <a href="/tags/fast-ai/" rel="tag"><i class="fa fa-tag"></i> fast.ai</a>
              <a href="/tags/%E6%A0%87%E6%B3%A8/" rel="tag"><i class="fa fa-tag"></i> 标注</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/pytorch-tutorial-TensorBoard/" rel="prev" title="PyTorch 番外篇：Pytorch中的TensorBoard（TensorBoard in PyTorch）">
                  <i class="fa fa-chevron-left"></i> PyTorch 番外篇：Pytorch中的TensorBoard（TensorBoard in PyTorch）
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/fastai-9-objctDetctMulti/" rel="next" title="在PASCAL VOC数据集上的多目标检测">
                  在PASCAL VOC数据集上的多目标检测 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments"><div id="twikoo-comments"></div></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2018 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-laptop"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">xiaohai</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/veraposeidon" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.8/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/quicklink/2.3.0/quicklink.umd.js" integrity="sha256-yvJQOINiH9fWemHn0vCA5lsHWJaHs6/ZmO+1Ft04SvM=" crossorigin="anonymous"></script>
  <script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":true,"delay":true,"timeout":3000,"priority":true,"url":"https://shenxiaohai.me/fastai-8-objctDetct/"}</script>
  <script src="/js/third-party/quicklink.js"></script>
<script class="next-config" data-name="twikoo" type="application/json">{"enable":true,"visitor":false,"envId":"https://twikoo-comment.shenxiaohai.me/","el":"#twikoo-comments"}</script>
<script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.twikoo.el)
    .then(() => NexT.utils.getScript(
      CONFIG.twikoo.jsUrl || 'https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js',
      { condition: window.twikoo }
    ))
    .then(() => {
      twikoo.init(CONFIG.twikoo);
    });
});
</script>
<style>
.post-block, .comments {
  overflow: visible;
}
.tk-owo-emotion {
  display: inline-block;
}
</style>

</body>
</html>
